<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "HTTP://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.myapp.service.BoardService">

    <select id="selectBoardList" parameterType="BoardVO" resultType="BoardVO">
		select b.seq
		, b.title
		, b.content
		, b.id
		, if(DATE_FORMAT(now(), '%c-%d') = DATE_FORMAT(b.registDate, '%c-%d'),DATE_FORMAT(b.registDate, '%H:%i'), DATE_FORMAT(b.registDate, '%m/%d')) as registDate
		, DATE_FORMAT(modifyDate, '%c-%d %h:%i') as modifyDate
		, deleteYn
		, b.viewCount
		, c.commentCount
		, row_number() over() as rowNum
		from board b
		left join (select count(*) as commentCount, boardSeq from comment group by boardSeq) c
		on b.seq = c.boardSeq
		where deleteYn = 'N'
        <choose>
        	<when test='title != null and content != null'>
        		and b.title like "%${content}%" ||  b.content like "%${content}%"
        	</when>
        	<when test='title != null'>
        		and b.title like "%${title}%"
        	</when>
			<when test='content != null'>
        		and b.content like "%${content}%"
        	</when>
        	<when test='id != null'>
        		and b.id like "%${id}%"
        	</when>        	
        </choose>
        	order by b.seq desc
        	limit #{pagePerNum} offset #{offset}
    </select>
      
    <select id="selectBoardListCnt" parameterType="BoardVO" resultType="int">
    	select 
    		count(*)
    	from board
    	where deleteYn = 'N'
        <choose>
        	<when test='title != null and content != null'>
        		and title like "%${content}%" ||  content like "%${content}%"
        	</when>
        	<when test='title != null'>
        		and title like "%${title}%"
        	</when>
			<when test='content != null'>
        		and content like "%${content}%"
        	</when>
        	<when test='id != null'>
        		and id like "%${id}%"
        	</when>        	
        </choose>
    </select>
    
    <select id="selectBoardOne" resultType="BoardVO" parameterType="int">
    	select * 
    		from board 
    	where seq = #{seq}
    </select>

	<update id="updateViewCount" parameterType="int">
		update board
		set viewCount = viewCount + 1
		where seq = #{seq}
	</update>
    
    <insert id="insertBoard" parameterType="BoardVO">
    	insert into board (
    			title,content,id,registDate,modifyDate,deleteYn
    		) 
    		values (
    			#{title},#{content},#{id},now(),now(),'N'
    		)
    </insert>
    
    <update id="deleteBoard" parameterType="int">
    	update board set deleteYn = 'Y' where seq = #{seq}
    </update>  
    
    <update id="updateBoard" parameterType="BoardVO">
    	update board
		set
    		title = #{title}
    		,content = #{content}
    		,modifyDate = now()
    	where seq = #{seq}
    </update>

	<insert id="insertComment" parameterType="CommentVO">
		insert into comment (
			content, boardSeq, id, registDate
		)
		values (
			#{content}, #{boardSeq}, #{id}, now()
		)
	</insert>

	<insert id="insertSubComment" parameterType="CommentVO">
		insert into comment (
		content, boardSeq, id, registDate, followSeq
		)
		values (
		#{content}, #{boardSeq}, #{id}, now(), #{followSeq}
		)
	</insert>

	<select id="selectComment" parameterType="int" resultType="CommentVO">
		select * from comment where boardSeq = #{boardSeq} and followSeq is null
	</select>

	<select id="selectSubComment" parameterType="int" resultType="CommentVO">
		select * from comment where boardSeq = #{boardSeq} and followSeq is not null
	</select>
    
    
    
</mapper>
